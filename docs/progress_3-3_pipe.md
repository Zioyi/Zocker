# 通过管道通信并识别环境变量

之前的实现是通过`/proc/self/exe init args`的方式来向子进程传递参数，执行想要命令。这样有一个缺点：如果用户输入的参数很长，或者其中带有一些特殊字符，那么这种方案就会失败。

解决这个问题，可以通过**进程间管道通信**的方式

在 Linux 创建两个进程时，进程间一般就会使用管道通信。所谓管道，就是一个连接两个进程的通道，它是Linux支持IPC的其中一种方式。一般来说，管道都是半双工的，一端进行写操作，另外一端进行读操作。



加入管道通信后的启动时序图如下：
![image](https://res.weread.qq.com/wrepub/epub_35537589_121)

- 第一步，在启动容器进程时，会返回一个连接着子进程的**写**管道，容器进程一端持有读管道，等待数据传入
- 第二步，通过Cgroup对容器进程做一些资源限制（cpu、内存等）
- 第三步，通过写管道将启动时设置的参数数据传入到容器进程中，出发任务持续，此时会将命令、参数以及环境变量一起传入`syscall.Exec`中
